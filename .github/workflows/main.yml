name: Main Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - master

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || format('push-{0}', github.ref) }}
  cancel-in-progress: true

jobs:
  check-skip:
  # Job to check if the commit message contains 'ci skip' or 'skip ci'
  # Only works on push events not on pull_request events
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - id: check
        run: |
          if [[ "${{ contains(github.event.head_commit.message, 'ci skip') || contains(github.event.head_commit.message, 'skip ci') }}" == "true" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping CI"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Running CI"
          fi
    permissions:
      contents: read

  test:
    needs: check-skip
    if: ${{ needs.check-skip.outputs.skip == 'false' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-test-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Enable corepack and install pnpm
        run: |
          corepack enable

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm -r test
    permissions:
      contents: read

  build-publish-library:
    needs: [check-skip, test]
    if: ${{ needs.check-skip.outputs.skip == 'false' && github.event.action != 'closed' }}
    uses: ./.github/workflows/shared-build-publish-libraries.yml
    concurrency:
      group: ${{ github.workflow }}-build-publish-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    secrets: inherit
    permissions:
      contents: write
      pages: write
      actions: write
      issues: write
      pull-requests: write  

  build-storybook:
    needs: [check-skip, build-publish-library]
    if: ${{ always() && needs.check-skip.outputs.skip == 'false' && (needs.build-publish-library.result == 'success' || needs.build-publish-library.result == 'skipped') }}
    uses: ./.github/workflows/shared-build-storybook.yml
    with:
      package-version: ${{ needs.build-publish-library.outputs.published-version }}
      name: storybook
      required-packages: '@infineon/infineon-design-system-stencil'
    permissions:
      contents: write
      pages: write

  build-examples:
    name: "build-example: ${{ matrix.short_name }}"
    needs: [check-skip, build-publish-library]
    if: ${{ always() && needs.check-skip.outputs.skip == 'false' && (needs.build-publish-library.result == 'success' || needs.build-publish-library.result == 'skipped') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: html-cdn-example
            short_name: html-cdn
            base_path: examples/html-cdn-example
            deploy_path: dist
            required_packages: '@infineon/infineon-design-system-stencil'
          - name: html-vite-example
            short_name: html-vite
            base_path: examples/html-vite-example
            deploy_path: dist
            required_packages: '@infineon/infineon-design-system-stencil'
          - name: angular-module-example
            short_name: angular-module
            base_path: examples/angular-module-example
            deploy_path: dist/browser
            required_packages: '@infineon/infineon-design-system-stencil,@infineon/infineon-design-system-angular'
          - name: angular-standalone-example
            short_name: angular-standalone
            base_path: examples/angular-standalone-example
            deploy_path: dist/browser
            required_packages: '@infineon/infineon-design-system-stencil,@infineon/infineon-design-system-angular'
          - name: react-example
            short_name: react
            base_path: examples/react-example
            deploy_path: dist
            required_packages: '@infineon/infineon-design-system-stencil,@infineon/infineon-design-system-react'
          - name: vue-example
            short_name: vue
            base_path: examples/vue-example
            deploy_path: dist
            required_packages: '@infineon/infineon-design-system-stencil,@infineon/infineon-design-system-vue'
    uses: ./.github/workflows/shared-build-example.yml
    with:
      package-version: ${{ needs.build-publish-library.outputs.published-version }}
      name: ${{ matrix.name }}
      base-path: ${{ matrix.base_path }}
      deploy-path: ${{ matrix.deploy_path }}
      required-packages: ${{ matrix.required_packages }}
    permissions:
      contents: write
      pages: write

  deploy-storybook:
    needs: [check-skip, build-publish-library, build-storybook]
    if: ${{ always() && needs.check-skip.outputs.skip == 'false' && (needs.build-publish-library.result == 'success' || needs.build-publish-library.result == 'skipped') }}
    uses: ./.github/workflows/shared-deploy-storybook.yml
    with:
      name: storybook
      deploy-path: storybook-static
      deployment: ${{ github.event_name == 'pull_request' && 'pr' || 'production' }}
      destination-dir: storybook
      umbrella-dir: pr-preview-storybook
    permissions:
      contents: write
      pages: write

  deploy-examples:
    name: "deploy-example: ${{ matrix.short_name }}"
    needs: [check-skip, build-publish-library, build-examples, deploy-storybook]
    if: ${{ always() && needs.check-skip.outputs.skip == 'false' && (needs.build-publish-library.result == 'success' || needs.build-publish-library.result == 'skipped') }}
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include:
          - name: html-cdn-example
            short_name: html-cdn
            label: HTML CDN Example
            deploy_path: dist
            destination_dir: html-cdn-example
            umbrella_dir: pr-preview-html-cdn-example
          - name: html-vite-example
            short_name: html-vite
            label: HTML Vite Example
            deploy_path: dist
            destination_dir: html-vite-example
            umbrella_dir: pr-preview-html-vite-example
          - name: angular-module-example
            short_name: angular-module
            label: Angular Example (Module)
            deploy_path: dist/browser
            destination_dir: angular-module-example
            umbrella_dir: pr-preview-angular-module-example
          - name: angular-standalone-example
            short_name: angular-standalone
            label: Angular Example (Standalone)
            deploy_path: dist/browser
            destination_dir: angular-standalone-example
            umbrella_dir: pr-preview-angular-standalone-example
          - name: react-example
            short_name: react
            label: React Example
            deploy_path: dist
            destination_dir: react-example
            umbrella_dir: pr-preview-react-example
          - name: vue-example
            short_name: vue
            label: Vue Example
            deploy_path: dist
            destination_dir: vue-example
            umbrella_dir: pr-preview-vue-example
    uses: ./.github/workflows/shared-deploy-example.yml
    with:
      name: ${{ matrix.name }}
      label: ${{ matrix.label }}
      deploy-path: ${{ matrix.deploy_path }}
      deployment: ${{ github.event_name == 'pull_request' && 'pr' || 'production' }}
      destination-dir: ${{ matrix.destination_dir }}
      umbrella-dir: ${{ matrix.umbrella_dir }}
    permissions:
      contents: write
      pages: write

  read-matrix-outputs:
    needs: [deploy-examples]
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: deploy-examples
    outputs:
      result: ${{ steps.read.outputs.result }}

  comment-pr:
    needs: [check-skip, build-publish-library, deploy-storybook, read-matrix-outputs]
    if: ${{ always() && needs.check-skip.outputs.skip == 'false' && github.event_name == 'pull_request' && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      VERSION: ${{ needs.build-publish-library.outputs.published-version }}
      STORYBOOK_URL: ${{ needs.deploy-storybook.outputs.url }}
      MATRIX_RESULTS: ${{ needs.read-matrix-outputs.outputs.result }}
    steps:
      - name: Build PR comment message
        id: build-comment
        run: |
          node <<'NODE'
          const items = [
            { key: 'html-cdn-example', label: 'HTML CDN Example' },
            { key: 'html-vite-example', label: 'HTML Vite Example' },
            { key: 'angular-module-example', label: 'Angular Example (Module)' },
            { key: 'angular-standalone-example', label: 'Angular Example (Standalone)' },
            { key: 'react-example', label: 'React Example' },
            { key: 'vue-example', label: 'Vue Example' },
          ];

          const matrixResults = process.env.MATRIX_RESULTS || '{}';
          let results = {};
          try {
            results = JSON.parse(matrixResults);
          } catch (error) {
            results = {};
          }

          const lines = [];
          lines.push('### Storybook Preview');
          const storybookUrl = process.env.STORYBOOK_URL || '';
          if (storybookUrl) {
            lines.push(`- [Storybook](${storybookUrl})`);
          } else {
            lines.push('- ⚠️ Storybook preview URL unavailable');
          }

          lines.push('');
          lines.push('### Preview Links for Deployed Examples');
          for (const item of items) {
            const url = results.url && results.url[item.key] ? results.url[item.key] : '';
            if (url) {
              lines.push(`- [${item.label}](${url})`);
            } else {
              lines.push(`- ⚠️ ${item.label}: preview URL unavailable`);
            }
          }

          lines.push('');
          lines.push(`Version: ${process.env.VERSION || ''}`);

          const message = lines.join('\n');
          const fs = require('fs');
          const output = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(output, `message<<EOF\n${message}\nEOF\n`);
          NODE

      - name: Comment PR with preview links
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: "PR Preview Links"
          message: ${{ steps.build-comment.outputs.message }}
